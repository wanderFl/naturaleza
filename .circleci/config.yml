version: 2.1
orbs:
 node: circleci/node@5.0.2
 slack: circleci/slack@4.12.5
jobs:
 build_project:
   docker:
     - image: cimg/node:18.19
   environment:
     GITHUB_REPO: "https://github.com/wanderFl/naturaleza.git"
   steps:
     - checkout
     - run:
         name: Prepare / Checkout
         command: |
           echo "üì¶ Clonando repositorio desde ${GITHUB_REPO}"
           git fetch --all
     - run:
         name: Install dependencies
         command: |
           if [ -f package.json ]; then
             echo "üì¶ Instalando dependencias..."
             npm ci || npm install
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json"
           fi
     - run:
         name: Build project
         command: |
           if [ -f package.json ]; then
             echo "üèóÔ∏è Compilando proyecto..."
             npm run build
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo build"
           fi
     # Mantengo todo igual:
     - persist_to_workspace:
         root: .
         paths:
           - node_modules
           - package.json
           - package-lock.json
           - dist
           - Dockerfile
 test_project:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     - attach_workspace:
         at: .
     - run:
         name: Run unit tests
         command: |
           if [ -f package.json ]; then
             echo "üß™ Ejecutando pruebas unitarias..."
             npm run test:unit -- --passWithNoTests || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo tests"
           fi
     - run:
         name: Lint code
         command: |
           if [ -f package.json ]; then
             echo "üîç Ejecutando lint..."
             npm run lint || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo lint"
           fi
     - run:
         name: CI Tests
         command: |
           if [ -f package.json ]; then
             echo "‚öôÔ∏è Ejecutando pruebas CI..."
             npm run test:ci
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo pruebas CI"
           fi
 slack_notifications:
   docker:
     - image: cimg/base:stable
   steps:
     - slack/notify:
         event: always
         channel: "#general-wanderley"
         custom: |
           {
             "text": "üßπ Pipeline finalizado. Limpieza de entorno..."
           }
     - slack/notify:
         event: pass
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚úÖ √âxito en CircleCI Pipeline Naturaleza"
           }
     - slack/notify:
         event: fail
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚ùå Fall√≥ el Pipeline de Naturaleza"
           }
 deploy_production:
   docker:
     - image: docker:stable
   steps:
     - checkout
     - attach_workspace:
         at: .
     - setup_remote_docker:
         docker_layer_caching: false
     - run:
         name: Build Docker image
         command: |
           echo "üê≥ Construyendo imagen Docker para producci√≥n..."
           docker build -t naturaleza-app:latest .
     - run:
         name: Run Docker container (simulaci√≥n de producci√≥n)
         command: |
           echo "üöÄ Ejecutando contenedor en modo producci√≥n..."
           docker run -d -p 8080:80 --name naturaleza naturaleza-app:latest
           echo "‚úÖ Aplicaci√≥n desplegada (simulada) en entorno de producci√≥n"
###############################################################################
# üü¢ NUEVO JOB AGREGADO ‚Äî NO SE MODIFIC√ì NADA DE LO EXISTENTE
###############################################################################
 push_docker_image:
   docker:
     - image: docker:stable
   steps:
     - checkout
     - attach_workspace:
         at: .
     - setup_remote_docker:
         docker_layer_caching: false
     # üî• NECESARIO PARA PERMITIR PUSH A DOCKER HUB
     - run:
         name: Docker Login
         command: |
           echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
     - run:
         name: Build Docker image for ArgoCD
         command: |
           echo "üê≥ Construyendo imagen Docker para ArgoCD..."
           docker build -t wanderleyfl/naturaleza-app:latest .
     - run:
         name: Push DockerHub image
         command: |
           echo "üì§ Subiendo imagen a DockerHub..."
           docker push wanderleyfl/naturaleza-app:latest
##########################################################################
# codigo nuevo
###############################################################################
# üîí DEVSECOPS - SAST SECURITY SCAN
###############################################################################
 security_sast_scan:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     # ‚úÖ CAMBIO MINIMO: evita checksum a una ruta que falla.
     # Usa el package-lock del repo (si existe siempre en tu root)
     - restore_cache:
         keys:
           - v1-security-deps-{{ checksum "api-json-vue/frontend-vue/package-lock.json" }}
           - v1-security-deps-
     - run:
         name: Install Security Dependencies
         command: |
           cd api-json-vue/frontend-vue
           echo "üì¶ Instalando dependencias de seguridad..."
           npm install
     # ‚úÖ CAMBIO MINIMO: cache key consistente con restore_cache
     - save_cache:
         paths:
           - api-json-vue/frontend-vue/node_modules
         key: v1-security-deps-{{ checksum "api-json-vue/frontend-vue/package-lock.json" }}
     - run:
         name: Run SAST Security Scan with ESLint
         command: |
           cd api-json-vue/frontend-vue
            echo "=========================================="
            echo "üîí Iniciando An√°lisis SAST con ESLint"
            echo "=========================================="
            # ‚úÖ CAMBIO MINIMO: usa el script que YA tienes y genera JSON
            npm run lint:security || true
            echo ""
            echo "=========================================="
            echo "üìä Resultados del An√°lisis de Seguridad"
            echo "=========================================="
            # Mostrar el reporte JSON formateado en terminal
            if [ -f eslint-security-report.json ]; then
              echo "‚úÖ Reporte generado exitosamente"
              echo ""
              echo "üìã Resumen de problemas detectados:"
              cat eslint-security-report.json | grep -E '"errorCount"|"warningCount"|"filePath"|"message"' || cat eslint-security-report.json
            else
              echo "‚ùå ERROR: No se pudo generar el reporte de seguridad"
              exit 1
            fi
     - run:
         name: Verify Security Standards
         command: |
           cd api-json-vue/frontend-vue
           echo "üîç Verificando est√°ndares de seguridad..."
           npm run lint
     - store_artifacts:
         path: api-json-vue/frontend-vue/eslint-security-report.json
         destination: security-reports/eslint-security-report.json
     - store_test_results:
         path: api-json-vue/frontend-vue
###############################################################################
workflows:
 version: 2
 build_test_deploy:
   jobs:
     - build_project:
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     - test_project:
         requires:
           - build_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     ###############################################################################
     #  DEVSECOPS - SAST Security Scan ejecutado despu√©s de test_project
     ###############################################################################
     - security_sast_scan:
         requires:
           - test_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     ###############################################################################
     # üü¢ NUEVA L√çNEA AGREGADA ‚Äî ejecutar push_docker_image despu√©s de test_project
     ###############################################################################
     - push_docker_image:
         requires:
           - test_project
         filters:
           branches:
             only:
               - main
     ###############################################################################
     - slack_notifications:
         requires:
           - test_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     - hold_for_approval:
         type: approval
         requires:
           - slack_notifications
         filters:
           branches:
             only: main
     - deploy_production:
         requires:
           - hold_for_approval
         filters:
           branches:
             only: main