version: 2.1
orbs:
 node: circleci/node@5.0.2
 slack: circleci/slack@4.12.5
jobs:
 build_and_test:
   docker:
     - image: cimg/node:18.19
   environment:
     GITHUB_REPO: "https://github.com/wanderFl/naturaleza.git"
   steps:
     - checkout
     - run:
         name: Prepare / Checkout
         command: |
           echo "ğŸ“¦ Clonando repositorio desde ${GITHUB_REPO}"
           git fetch --all
     - run:
         name: Install dependencies
         command: |
           if [ -f package.json ]; then
             echo "ğŸ“¦ Instalando dependencias..."
             npm ci || npm install
           else
             echo "âš ï¸ No se encontrÃ³ package.json"
           fi
     - run:
         name: Build project
         command: |
           if [ -f package.json ]; then
             echo "ğŸ—ï¸ Compilando proyecto..."
             npm run build
           else
             echo "âš ï¸ No se encontrÃ³ package.json, omitiendo build"
           fi
     - run:
         name: Run unit tests
         command: |
           if [ -f package.json ]; then
             echo "ğŸ§ª Ejecutando pruebas unitarias..."
             npm run test:unit -- --passWithNoTests || true
           else
             echo "âš ï¸ No se encontrÃ³ package.json, omitiendo tests"
           fi
     - run:
         name: Lint code
         command: |
           if [ -f package.json ]; then
             echo "ğŸ” Ejecutando lint..."
             npm run lint || true
           else
             echo "âš ï¸ No se encontrÃ³ package.json, omitiendo lint"
           fi
     - run:
         name: CI Tests
         command: |
           if [ -f package.json ]; then
             echo "âš™ï¸ Ejecutando pruebas CI..."
             npm run test:ci
           else
             echo "âš ï¸ No se encontrÃ³ package.json, omitiendo pruebas CI"
           fi
     - run:
         name: Deploy to STAGING
         command: |
           echo "ğŸš€ Deploy to STAGING (simulado)"
     - slack/notify:
         event: always
         channel: "#general-wanderley"
         custom: |
           {
             "text": "ğŸ§¹ Pipeline finalizado. Limpieza de entorno..."
           }
     - slack/notify:
         event: pass
         channel: "#general-wanderley"
         custom: |
           {
             "text": "âœ… Ã‰xito en CircleCI Pipeline Naturaleza"
           }
     - slack/notify:
         event: fail
         channel: "#general-wanderley"
         custom: |
           {
             "text": "âŒ FallÃ³ el Pipeline de Naturaleza"
           }
 deploy_production:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     - run:
         name: Manual approval and deploy
         command: |
           echo "ğŸš€ Deploy to PRODUCTION (simulado)"
           echo "Esperando aprobaciÃ³n manual en workflow..."
workflows:
 version: 2
 build_test_deploy:
   jobs:
     - build_and_test
     - hold_for_approval:
         type: approval
         requires:
           - build_and_test
     - deploy_production:
         requires:
           - hold_for_approval