version: 2.1
orbs:
 node: circleci/node@5.0.2
 slack: circleci/slack@4.12.5

jobs:
 build_project:
   docker:
     - image: cimg/node:18.19
   environment:
     GITHUB_REPO: "https://github.com/wanderFl/naturaleza.git"
   steps:
     - checkout
     - run:
         name: Prepare / Checkout
         command: |
           echo "üì¶ Clonando repositorio desde ${GITHUB_REPO}"
           git fetch --all
     - run:
         name: Install dependencies
         command: |
           if [ -f package.json ]; then
             echo "üì¶ Instalando dependencias..."
             npm ci || npm install
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json"
           fi
     - run:
         name: Build project
         command: |
           if [ -f package.json ]; then
             echo "üèóÔ∏è Compilando proyecto..."
             npm run build
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo build"
           fi

     # Mantengo todo igual:
     - persist_to_workspace:
         root: .
         paths:
           - node_modules
           - package.json
           - package-lock.json
           - dist
           - Dockerfile

 test_project:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     - attach_workspace:
         at: .
     - run:
         name: Run unit tests
         command: |
           if [ -f package.json ]; then
             echo "üß™ Ejecutando pruebas unitarias..."
             npm run test:unit -- --passWithNoTests || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo tests"
           fi
     - run:
         name: Lint code
         command: |
           if [ -f package.json ]; then
             echo "üîç Ejecutando lint..."
             npm run lint || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo lint"
           fi
     - run:
         name: CI Tests
         command: |
           if [ -f package.json ]; then
             echo "‚öôÔ∏è Ejecutando pruebas CI..."
             npm run test:ci
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo pruebas CI"
           fi

 slack_notifications:
   docker:
     - image: cimg/base:stable
   steps:
     - slack/notify:
         event: always
         channel: "#general-wanderley"
         custom: |
           {
             "text": "üßπ Pipeline finalizado. Limpieza de entorno..."
           }
     - slack/notify:
         event: pass
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚úÖ √âxito en CircleCI Pipeline Naturaleza"
           }
     - slack/notify:
         event: fail
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚ùå Fall√≥ el Pipeline de Naturaleza"
           }

 deploy_production:
   docker:
     - image: docker:stable
   steps:
     - checkout
     - attach_workspace:
         at: .
     - setup_remote_docker:
          docker_layer_caching: false
     - run:
         name: Build Docker image
         command: |
           echo "üê≥ Construyendo imagen Docker para producci√≥n..."
           docker build -t naturaleza-app:latest .
     - run:
         name: Run Docker container (simulaci√≥n de producci√≥n)
         command: |
           echo "üöÄ Ejecutando contenedor en modo producci√≥n..."
           docker run -d -p 8080:80 --name naturaleza naturaleza-app:latest
           echo "‚úÖ Aplicaci√≥n desplegada (simulada) en entorno de producci√≥n"

###############################################################################
# üü¢ NUEVO JOB AGREGADO ‚Äî NO SE MODIFIC√ì NADA DE LO EXISTENTE
###############################################################################
 push_docker_image:
   docker:
     - image: docker:stable
   steps:
     - checkout
     - attach_workspace:
         at: .
     - setup_remote_docker:
          docker_layer_caching: false
     - run:
         name: Build Docker image for ArgoCD
         command: |
           echo "üê≥ Construyendo imagen Docker para ArgoCD..."
           docker build -t wanderfl/naturaleza-app:latest .
     - run:
         name: Push DockerHub image
         command: |
           echo "üì§ Subiendo imagen a DockerHub..."
           docker push wanderfl/naturaleza-app:latest
###############################################################################

workflows:
 version: 2
 build_test_deploy:
   jobs:
     - build_project:
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     - test_project:
         requires:
           - build_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     ###############################################################################
     # üü¢ NUEVA L√çNEA AGREGADA ‚Äî ejecutar push_docker_image despu√©s de test_project
     ###############################################################################
     - push_docker_image:
         requires:
           - test_project
         filters:
           branches:
             only:
               - main
     ###############################################################################
     - slack_notifications:
         requires:
           - test_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     - hold_for_approval:
         type: approval
         requires:
           - slack_notifications
         filters:
           branches:
             only: main
     - deploy_production:
         requires:
           - hold_for_approval
         filters:
           branches:
             only: main