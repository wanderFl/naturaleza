version: 2.1
orbs:
 node: circleci/node@5.0.2
 slack: circleci/slack@4.12.5
jobs:
 build_project:
   docker:
     - image: cimg/node:18.19
   environment:
     GITHUB_REPO: "https://github.com/wanderFl/naturaleza.git"
   steps:
     - checkout
     - run:
         name: Prepare / Checkout
         command: |
           echo "üì¶ Clonando repositorio desde ${GITHUB_REPO}"
           git fetch --all
     - run:
         name: Install dependencies
         command: |
           if [ -f package.json ]; then
             echo "üì¶ Instalando dependencias..."
             npm ci || npm install
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json"
           fi
     - run:
         name: Build project
         command: |
           if [ -f package.json ]; then
             echo "üèóÔ∏è Compilando proyecto..."
             npm run build
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo build"
           fi
     # ‚úÖ Guardar dependencias y c√≥digo para los siguientes jobs
     - persist_to_workspace:
         root: .
         paths:
           - node_modules
           - package.json
           - package-lock.json
           - dist
 test_project:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     # ‚úÖ Recuperar dependencias del build anterior
     - attach_workspace:
         at: .
     - run:
         name: Run unit tests
         command: |
           if [ -f package.json ]; then
             echo "üß™ Ejecutando pruebas unitarias..."
             npm run test:unit -- --passWithNoTests || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo tests"
           fi
     - run:
         name: Lint code
         command: |
           if [ -f package.json ]; then
             echo "üîç Ejecutando lint..."
             npm run lint || true
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo lint"
           fi
     - run:
         name: CI Tests
         command: |
           if [ -f package.json ]; then
             echo "‚öôÔ∏è Ejecutando pruebas CI..."
             npm run test:ci
           else
             echo "‚ö†Ô∏è No se encontr√≥ package.json, omitiendo pruebas CI"
           fi
 slack_notifications:
   docker:
     - image: cimg/base:stable
   steps:
     - slack/notify:
         event: always
         channel: "#general-wanderley"
         custom: |
           {
             "text": "üßπ Pipeline finalizado. Limpieza de entorno..."
           }
     - slack/notify:
         event: pass
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚úÖ √âxito en CircleCI Pipeline Naturaleza"
           }
     - slack/notify:
         event: fail
         channel: "#general-wanderley"
         custom: |
           {
             "text": "‚ùå Fall√≥ el Pipeline de Naturaleza"
           }
 deploy_production:
   docker:
     - image: cimg/node:18.19
   steps:
     - checkout
     # ‚úÖ (opcional) recuperar workspace si alg√∫n artefacto fuera necesario
     - attach_workspace:
         at: .
     - run:
         name: Manual approval and deploy
         command: |
           echo "üöÄ Deploy a PRODUCCI√ìN (simulado)"
           echo "Esperando aprobaci√≥n manual en workflow..."
workflows:
 version: 2
 build_test_deploy:
   jobs:
     # ‚úÖ Ejecutar siempre (feature/* y main)
     - build_project:
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     - test_project:
         requires:
           - build_project
         filters:
           branches:
             only:
               - main
               - /feature\/.*/
     # ‚úÖ Notificaciones y despliegue solo para main
     - slack_notifications:
         requires:
           - test_project
         filters:
           branches:
             only: main
     - hold_for_approval:
         type: approval
         requires:
           - slack_notifications
         filters:
           branches:
             only: main
     - deploy_production:
         requires:
           - hold_for_approval
         filters:
           branches:
             only: main